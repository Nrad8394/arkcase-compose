version: '3.8'

services:
  # PostgreSQL Database (or you can use MySQL/MariaDB)
  postgres:
    image: postgres:14-alpine
    container_name: arkcase-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: arkcase
      POSTGRES_USER: arkcase
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
      POSTGRES_MULTIPLE_DATABASES: alfresco
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - arkcase-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U arkcase"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # Apache Solr for Search
  solr:
    image: solr:8.11
    container_name: arkcase-solr
    restart: unless-stopped
    environment:
      SOLR_JAVA_MEM: "-Xms1g -Xmx2g"
      ZK_HOST: ""
    volumes:
      - solr-data:/var/solr
    networks:
      - arkcase-network
    command:
      - solr-precreate
      - arkcase
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8983/solr/arkcase/admin/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 2G

  # Apache ActiveMQ
  activemq:
    image: rmohr/activemq:5.15.9-alpine
    container_name: arkcase-activemq
    restart: unless-stopped
    environment:
      ACTIVEMQ_MIN_MEMORY: 512
      ACTIVEMQ_MAX_MEMORY: 2048
      ACTIVEMQ_ADMIN_LOGIN: admin
      ACTIVEMQ_ADMIN_PASSWORD: ${ACTIVEMQ_PASSWORD:-admin123}
    ports:
      - "8161:8161"  # Web Console
      - "61616:61616"  # OpenWire
      - "5672:5672"  # AMQP
      - "61613:61613"  # STOMP
      - "1883:1883"  # MQTT
      - "61614:61614"  # WS
    volumes:
      - activemq-data:/opt/activemq/data
      - activemq-conf:/opt/activemq/conf
    networks:
      - arkcase-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8161/admin/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 1G

  # Alfresco Content Services (ECM Repository)
  alfresco:
    image: alfresco/alfresco-content-repository-community:7.4.1
    container_name: arkcase-alfresco
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      JAVA_TOOL_OPTIONS: >
        -Dencryption.keystore.type=JCEKS
        -Dencryption.cipherAlgorithm=DESede/CBC/PKCS5Padding
        -Dencryption.keyAlgorithm=DESede
        -Dencryption.keystore.location=/usr/local/tomcat/shared/classes/alfresco/extension/keystore/keystore
        -Dmetadata-keystore.password=mp6yc0UD9e
        -Dmetadata-keystore.aliases=metadata
        -Dmetadata-keystore.metadata.password=oKIWzVdEdA
        -Dmetadata-keystore.metadata.algorithm=DESede
      JAVA_OPTS: >
        -Ddb.driver=org.postgresql.Driver
        -Ddb.username=arkcase
        -Ddb.password=${DB_PASSWORD:-changeme}
        -Ddb.url=jdbc:postgresql://postgres:5432/alfresco
        -Dsolr.host=solr
        -Dsolr.port=8983
        -Dsolr.http.connection.timeout=1000
        -Dsolr.secureComms=secret
        -Dsolr.sharedSecret=secret
        -Dsolr.base.url=/solr
        -Dindex.subsystem.name=solr6
        -Dshare.host=alfresco-share
        -Dshare.port=8080
        -Dalfresco.host=localhost
        -Dalfresco.port=8080
        -Daos.baseUrlOverwrite=http://localhost:8080/alfresco/aos
        -Dmessaging.broker.url="failover:(nio://activemq:61616)?timeout=3000&jms.useCompression=true"
        -Ddeployment.method=DOCKER_COMPOSE
        -DlocalTransform.core-aio.url=http://transform-core-aio:8090/
        -Dcsrf.filter.enabled=false
        -Xms1g -Xmx3g
    volumes:
      - alfresco-data:/usr/local/tomcat/alf_data
    networks:
      - arkcase-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/alfresco/api/-default-/public/alfresco/versions/1/probes/-ready- || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G

  # Alfresco Share (UI for Alfresco)
  alfresco-share:
    image: alfresco/alfresco-share:7.4.1
    container_name: arkcase-alfresco-share
    restart: unless-stopped
    depends_on:
      alfresco:
        condition: service_healthy
    environment:
      REPO_HOST: alfresco
      REPO_PORT: 8080
      JAVA_OPTS: >
        -Xms512m
        -Xmx1g
        -Dalfresco.host=localhost
        -Dalfresco.port=8080
        -Dalfresco.context=alfresco
        -Dalfresco.protocol=http
    networks:
      - arkcase-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/share || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # Transform Core AIO (for document transformations)
  transform-core-aio:
    image: alfresco/alfresco-transform-core-aio:3.0.0
    container_name: arkcase-transform-core-aio
    restart: unless-stopped
    environment:
      JAVA_OPTS: -Xms256m -Xmx512m
    networks:
      - arkcase-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8090/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # Pentaho Business Intelligence
  pentaho:
    image: public.ecr.aws/arkcase/pentaho:latest
    container_name: arkcase-pentaho
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PENTAHO_DI_JAVA_OPTIONS: "-Xms1024m -Xmx2048m"
      DB_TYPE: postgresql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: arkcase
      DB_USER: arkcase
      DB_PASSWORD: ${DB_PASSWORD:-changeme}
    volumes:
      - pentaho-data:/opt/pentaho/server/pentaho-server/pentaho-solutions/system
    networks:
      - arkcase-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/pentaho || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 2G

  # Spring Cloud Config Server
  config-server:
    image: public.ecr.aws/arkcase/config-server:latest
    container_name: arkcase-config-server
    restart: unless-stopped
    environment:
      SERVER_PORT: 9999
      SPRING_PROFILES_ACTIVE: native
      SPRING_CLOUD_CONFIG_SERVER_NATIVE_SEARCH_LOCATIONS: file:///config
    volumes:
      - ./arkcase-config:/config:ro
    networks:
      - arkcase-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9999/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # ArkCase Core Application
  arkcase-core:
    image: public.ecr.aws/arkcase/core:latest
    container_name: arkcase-core
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      solr:
        condition: service_healthy
      activemq:
        condition: service_healthy
      alfresco:
        condition: service_healthy
      config-server:
        condition: service_healthy
    environment:
      JAVA_OPTS: >
        -Xms2g -Xmx4g
        -Dspring.datasource.url=jdbc:postgresql://postgres:5432/arkcase
        -Dspring.datasource.username=arkcase
        -Dspring.datasource.password=${DB_PASSWORD:-changeme}
        -Dspring.datasource.driver-class-name=org.postgresql.Driver
        -Dsolr.host=solr
        -Dsolr.port=8983
        -Dactivemq.broker.url=tcp://activemq:61616
        -Dalfresco.host=alfresco
        -Dalfresco.port=8080
        -Dpentaho.host=pentaho
        -Dpentaho.port=8080
        -Dconfig.server.url=http://config-server:9999
        -Dacm.configurationserver.url=http://config-server:9999
      CATALINA_OPTS: >
        -Dserver.ssl.enabled=true
        -Dserver.ssl.key-store=/opt/arkcase/certs/keystore.p12
        -Dserver.ssl.key-store-password=${KEYSTORE_PASSWORD:-changeme}
        -Dserver.ssl.keyStoreType=PKCS12
    ports:
      - "8843:8843"  # HTTPS
      - "8080:8080"  # HTTP (redirect to HTTPS)
    volumes:
      - arkcase-data:/opt/arkcase/data
      - ./arkcase-config:/opt/arkcase/config:ro
      - arkcase-logs:/opt/arkcase/logs
      - ./certs:/opt/arkcase/certs:ro
    networks:
      - arkcase-network
    healthcheck:
      test: ["CMD-SHELL", "curl -k -f https://localhost:8843/arkcase/api/v1/plugin/admin/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
    deploy:
      resources:
        limits:
          memory: 6G
        reservations:
          memory: 4G

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: arkcase-nginx
    restart: unless-stopped
    depends_on:
      arkcase-core:
        condition: service_healthy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certs:/etc/nginx/certs:ro
      - nginx-logs:/var/log/nginx
    networks:
      - arkcase-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

networks:
  arkcase-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  postgres-data:
    driver: local
  solr-data:
    driver: local
  activemq-data:
    driver: local
  activemq-conf:
    driver: local
  alfresco-data:
    driver: local
  pentaho-data:
    driver: local
  arkcase-data:
    driver: local
  arkcase-config:
    driver: local
  arkcase-logs:
    driver: local
  nginx-logs:
    driver: local
